<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>        
</head>

<body>
    <div class="row">
        <div id="controls_box" class="container">
            <x-tile id="trash" class="control locked">&#x1f5d1;</x-tile>
            <x-tile id="reload" class="control locked">&#x21ba;</x-tile>
        </div>
    </div>
    <div class="row">
        <div id="letters_box" class="container">
        </div>
    </div>
</body>
<style>

:root
{    
    --size-cell: 9vh;    
}

* 
{
    position: relative;
}

body
{
    display: table;
    overflow: hidden; /* Hide scrollbars */
}

x-tile
{
    -moz-user-select: none;
    -ms-user-select: none;
    -webkit-user-select: none;
    background-color: red;
    border-radius: 1vh;
    border: 1px solid black;
    color: white;
    display: inline-block;    
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    font-size: 8vh;    
    height: var(--size-cell);
    line-height: var(--size-cell);  
    padding-bottom: 2vh;
    padding-left: 1vh;
    padding-right: 1vh;
    text-align: center;
    user-select: none;
    vertical-align:top;
    width: var(--size-cell);
}

.control, x-tile.locked
{
    background-color: lightgrey;
    color: black; 
}


x-tile.hoverdrag
{
    background-color: gray;
}

.container, .pseudo_container
{        
    display: inline-block;
}

.row
{
    display: block;
    float:none;
}

.cell
{    
    position: relative;
    display: inline;    
}

.rainbow {
    background: linear-gradient(
        90deg,
        rgba(255, 0, 0, 1) 0%,
        rgba(255, 154, 0, 1) 10%,
        rgba(208, 222, 33, 1) 20%,
        rgba(79, 220, 74, 1) 30%,
        rgba(63, 218, 216, 1) 40%,
        rgba(47, 201, 226, 1) 50%,
        rgba(28, 127, 238, 1) 60%,
        rgba(95, 21, 242, 1) 70%,
        rgba(186, 12, 248, 1) 80%,
        rgba(251, 7, 217, 1) 90%,
        rgba(255, 0, 0, 1) 100%
    );
}

</style>

<script>

    var dragging = false;

    HTMLCollection.prototype.forEach = Array.prototype.forEach;

    HTMLElement.prototype.getCustomTagName = function(){
        var tagStr = this.localName.split("-")[1];
        return "X" + tagStr[0].toLocaleUpperCase() + tagStr.slice(1);        
    }

    HTMLElement.prototype.enumerate = function()
    {
        var othersCollection = document.getElementsByTagName(this.localName);
        var count = othersCollection.length;
        this.dataset["id"] = count;
        this.id = this.getCustomTagName() + "_" + count;  
    }

    HTMLElement.prototype.isOffPage = function()
    {
        var rect = this.getBoundingClientRect();
        var midX = (rect.right + rect.left) / 2;
        var midY = (rect.top + rect.bottom) / 2;
        return midX < 0 || midX > window.innerWidth || midY < 0 || midY > window.innerHeight;
    }

    function isDivInView(div) {
        const rect = div.getBoundingClientRect();

        return (
            rect.top >= 0 &&
            rect.left >= 0 &&
            rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) &&
            rect.right <= (window.innerWidth || document.documentElement.clientWidth)
        );
    }

    class XTile extends HTMLElement
    {
        constructor(contents)
        {
            super();
            if (contents)
            {
                this.innerText = contents;
            }
            this.pos1 = 0;
            this.pos2 = 0;
            this.pos3 = 0;
            this.pos4 = 0;
            this.style.cursor = "move";
            this.style.position = "absolute";
            this.draggable = true;
            this.distanceTo = [];
            this.dragging = false;
        }

        updateRadar()
        {
            var width = this.getBoundingClientRect().width;
            var middle = width/2;
            var x1 = this.offsetLeft + middle;
            var y1 = this.offsetTop + middle;        
            var letterTiles = document.getElementsByTagName("x-tile");
            letterTiles.forEach( (tile) => {
                if (tile.id != this.id)
                {
                    var x2 = tile.offsetLeft + middle;
                    var y2 = tile.offsetTop + middle;
                    var angle = direction(x1,y1,x2,y2);
                    var dist = distance(x1,y1,x2,y2);
                }
            });  
        }

        restrictObject(e, movementX, movementY)
        {
            var rect = this.getBoundingClientRect();
            var dragMargin = rect.width / 2;
            var inWidth = movementX >= dragMargin && movementX < (window.innerWidth - dragMargin);
            var inHeight = movementY >= dragMargin && movementY < (window.innerHeight - dragMargin);
            if (!inWidth || !inHeight) return;
        }

        moveObject(e, movementX, movementY)
        {
            pushOtherTilesBack(this);
            this.pos1 = this.pos3 - movementX;
            this.pos2 = this.pos4 - movementY;
            this.setPosition(movementX, movementY);
        }   
    
        lockTile()
        {   
            this.draggable = false;
            this.style = "";
        }

        setPosition(newX, newY) {
            pushOtherTilesBack(this);
            this.pos3 = newX;
            this.pos4 = newY;
            this.style.top = (this.offsetTop - this.pos2) + "px";
            this.style.left = (this.offsetLeft - this.pos1) + "px";
        }
    }

    customElements.define('x-tile', XTile);

    function do_dragstart(event)
    {
        console.log(this, event);
        var tile = event.target;
        tile.addEventListener("dragend", do_dragend);
        tile.dragging = true;
        while (tile.dragging) {
            tile.setPosition(event.clientX, event.clientY);
        }
        // tile.setPosition(event.clientX, event.clientY);
        // tile.moveObject(event, event.movementX, event.movementY);
    }

    function do_drag(event)
    {
        console.log(this, event);
        var tile = event.target;
        tile.setPosition(event.clientX, event.clientY);
        console.log(event.clientX, event.clientY);
    }

    function do_dragend(event)
    {
        console.log(this, event);
        var tile = event.target;
        tile.dragging = false;
        // tile.removeEventListener("dragend", do_dragend);
        tile.setPosition(event.x, event.y);
        console.log(event.x, event.y);
        if (tile.isOffPage())
        {
            if (!isLastLetter(tile)) 
            {
                tile.remove();
            } 
        }
    }

    function isLastLetter(tile)
    {
        var count = 0;
        var others = document.getElementsByTagName("x-tile");
        others.forEach((tile)=>{
            if (tile.innerText == this.innerText) count++;
        });
        return count == 1;
    }

    function do_touchstart(event) 
    {
        console.log(this, event);
        var tile = event.target;
        tile.setPosition(event.touches[0].clientX, event.touches[0].clientY);
    }

    function do_mousedown(event) 
    {
        console.log(this, event);
        var tile = event.target;
        tile.dragging = true;
        // tile.addEventListener("mousemove", do_mousemove);
        tile.setPosition(event.clientX, event.clientY);
        // tile.addEventListener("mouseup", do_mouseup);
    }

    function do_mousemove(event) 
    {        
        console.log(this, event);
        var tile = event.target;
        // if (isLastLetter(tile)) tile.restrictObject(event, event.clientX, event.clientY);
        if (tile.dragging) tile.setPosition(event.clientX, event.clientY);
        // tile.moveObject(event, event.movementX, event.movementY);
    }

    function do_mouseup(event)
    {
        console.log(this, event);
        var tile = event.target;
        tile.dragging = false;
        // tile.removeEventListener("mousemove", do_mousemove);
        // tile.removeEventListener("mouseup", do_mouseup);
        // tile.setPosition(event.clientX, event.clientY);
        // if (tile.isOffPage())
        // {
        //     if (!isLastLetter(tile)) 
        //     {
        //         tile.remove();
        //     } 
        // }
    }

    function pushOtherTilesBack(thistile)
    {        
        var letters = document.getElementsByTagName("x-tile");
        var toBeRemoved = [];
        for (var i=letters.length - 1; i>=0; i--)
        {
            var tile = letters[i];
            if (tile.id != thistile.id) tile.style.zIndex=i;
            else tile.style.zIndex = letters.length;
        }
        toBeRemoved.forEach((item) => item.remove());
    }

    function do_touchmove(event) 
    {
        console.log(this, event);
        var tile = event.target; 
        if (isLastLetter(tile)) tile.restrictObject(event, event.touches[0].clientX, event.touches[0].clientY);
        tile.moveObject(event, event.touches[0].clientX, event.touches[0].clientY)
    }

    function dragOverHandler(event) {
        console.log(this, event);
        event.dataTransfer.dropEffect = 'move';
        const data = event.dataTransfer.getData('text'); // Or other data types
    }

    function dropHandler(event) {
        console.log(this, event, data);
        const data = event.dataTransfer.getData('text'); // Or other data types
    }

    function onMouseOver(event)
    {
        // console.log(event);
    }

    function getColorParameter() {
        let params = new URLSearchParams(document.location.search);
        let color = params.get("color")                                                                                                                                                                                                                          
        if (!color) color = "red";
        console.log(color);
        return color;
    }

    function configureControls()
    {
        document.getElementsByClassName("control").forEach((element)=>{ element.lockTile(); });
        document.getElementById("reload").addEventListener("click", function(){ location.reload(); }, false);
        document.addEventListener("keyup", (e)=>{
            var letter = ("" + e.key).toLowerCase();
            copyLetter(letter); 
        }, false);
        document.getElementById("trash").addEventListener("drop", dropHandler, false );
        document.getElementById("trash").addEventListener("dragover", dragOverHandler, false );

    }

    letterTiles = [];
    function addTiles(color)
    {    
        const letters = "abcdefghijklmnopqrstuvwxyz"; 
        var i = 0;
        var offsetX = 0;
        var offsetY = 0;
        for (var i=0; i<letters.length; i++)
        {
            var letter = letters[i];
            var tile = newLetterTile(letter, offsetX, offsetY);
            // tile.addEventListener('dragstart', (event) => {
            //     console.log("dragstart:", event);
            //     event.dataTransfer.setData('text/plain', event);
            // }, false);
            document.getElementById("letters_box").appendChild(tile);
            tile.style.top = offsetY + "px";
            tile.style.left = offsetX + "px";
            tile.style.zIndex -= 1;
            var bounds = tile.getBoundingClientRect();
            var size = bounds.width;
            offsetX = offsetX + size;
            if (offsetX > (window.innerWidth - size))
            {
                offsetY += size;
                offsetX = 0;
            }
            letterTiles[i] = tile;
        };
    }

    function deleteLetter(event)
    {
        // console.log(event);
    }

    function copyLetter(letter)
    {
        var letters = document.getElementsByTagName("x-tile");
        var letters_box = document.getElementById("letters_box");
        for (var i=letters.length - 1; i>=0; i--)
        {
            var tile = letters[i];
            if (tile.innerText == letter)
            {
                var bounds = tile.getBoundingClientRect();
                var copyOffset = bounds.width / 8;
                var top = tile.offsetTop + copyOffset;
                var left = tile.offsetLeft + copyOffset;
                var newTile = newLetterTile(letter, top, left, copyOffset);
                letters_box.appendChild(newTile);
                pushOtherTilesBack(newTile);
                break;
            }
        }
    }

    function newLetterTile(letter, top, left, offset) 
    {
        var newTile = new XTile(letter);
        var bounds = newTile.getBoundingClientRect();
        if (offset == null) offset = bounds.width / 2;
        newTile.style.top = (top + offset) + "px";
        newTile.style.left = (left + offset) + "px";
        colorParam = getColorParameter();
        if (colorParam == "rainbow") {
            newTile.classList.add("rainbow");
        } else {
            newTile.style.backgroundColor = colorParam;
        }
        newTile.id = newTile.getCustomTagName() + "_" + window.crypto.randomUUID().split('-')[0];
        // newTile.addEventListener("dragstart", do_drag);
        // newTile.addEventListener("dragend", do_dragend);
        newTile.addEventListener("mousedown", do_mousedown);
        newTile.addEventListener("mousemove", do_mousemove);
        newTile.addEventListener("mouseup", do_mouseup);
        newTile.addEventListener("mouseout", do_mouseup);
        newTile.addEventListener("touchstart", do_touchstart);
        newTile.addEventListener("touchmove", do_touchmove);
        return newTile;
    }

    function distance(x1,y1,x2,y2)
    {
        return Math.sqrt( Math.pow((x2-x1), 2) + Math.pow((y2-y1), 2) );
    }

    function direction(x1,y1,x2,y2)
    {
        return Math.atan2(y2-y1,x2-x1) * 180 / Math.PI;
    }

    document.addEventListener("DOMContentLoaded", function(event){
        configureControls();
        addTiles();
    });

</script>

</html> 

/