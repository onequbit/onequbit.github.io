<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
</head>

<body>
    <div class="controls">
        <button id="btnLastYear">Previous Year</button>
    </div>
    <div class="controls">
        <label id="currentYear"></label>
    </div>
    <div class="controls">
        <button id="btnNextYear">Next Year</button>
    </div>
    <div class="controls">
        <select id="selectMonth"></select>
    </div>
    <br>
    <hr>
    <div id="calendar"></div>
</body>

<script>

    const SUNDAY = 0;
    const MONDAY = 1;
    const TUESDAY = 2;
    const WEDNESDAY = 3;
    const THURSDAY = 4;
    const FRIDAY = 5;
    const SATURDAY = 6;

    const JANUARY = 0;
    const FEBRUARY = 1;
    const MARCH = 2;
    const APRIL = 3;
    const MAY = 4;
    const JUNE = 5;
    const JULY = 6; 
    const AUGUST = 7;
    const SEPTEMBER = 8;
    const OCTOBER = 9;
    const NOVEMBER = 10;
    const DECEMBER = 11;

    const MONTHS = ["January","February","March","April","May","June","July","August","September","October","November","December"];
    const WEEKDAYS = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];

    const DAY = 1000 * 60 * 60 * 24;
    const WEEK = DAY * 7;
    const BIWEEK = WEEK * 2;
    const YEAR = DAY * 365;
    
    // 2012 Federal Pay Period 1 : 20120101

    Number.prototype.toDigits = function(len) 
    {
        var str = this + '';
        while (str.length < len)
            str = '0' + str;
        return str;
    }
    
    Date.prototype.getWeekDay = function()
    {        
        return WEEKDAYS[this.getDay()];
    }

    Date.prototype.nextDate = function(days = 1)
    {
        this.setDate(this.getDate()+days);        
    }

    Date.nthDayOfMonth = function(count, day, month, year, name = "")
    {
        if (year == null) year = new Date().getFullYear();
        var date = new Date(year, month, 1);
        var counter = 0;
        if (date.getWeekDay() == WEEKDAYS[day]) counter++;
        while (counter < count) 
        {
            date.nextDate();
            if (date.getWeekDay() == WEEKDAYS[day]) counter++;
        }
        date.holidayName = name;
        return date;
    }

    Date.lastDayOfMonth = function(day, month, year, name = "")
    {        
        if (year == null) year = new Date().getFullYear();
        var date = new Date(year, month, 1);
        var list = [];
        while (date.getMonth() == month) 
        {
            if (date.getWeekDay() == WEEKDAYS[day])
            {                
                list.push(new Date(date));                
            } 
            date.nextDate();            
            if (date.getMonth() > month) break;                     
        }
        date = list.pop();
        date.holidayName = name;
        return date;
    }

    Date.prototype.backDate = function(offset)
    {
        this.setDate(this.getDate() - offset);
        this.isBackdate = true;        
        return this;
    }

    Date.findSetHoliday = function(month, date, year, name = "")
    {
        if (year == null) year = new Date().getFullYear();
        var holiday = new Date(year, month, date);
        if (holiday.getDay() == SATURDAY)
        {
            holiday.backDate(1);            
        }
        else if (holiday.getDay() == SUNDAY)
        {
            holiday.nextDate();
        }
        holiday.holidayName = name;
        return holiday; 
    }

    Date.NewYear = function(year)
    {
        var newDate = new Date();
        if (year == null) year = new Date().getFullYear();
        newDate.setFullYear(year);
        newDate.setDate(1);
        newDate.setMonth(JANUARY);
        newDate.holidayName = "New Year's Day"
        return newDate;        
    }

    Date.getFederalHolidays = function(startDate)
    {
        function calendarYear(month)
        {
            if (month < startDate.getMonth()) 
                return startDate.getFullYear() + 1;
            else
                return startDate.getFullYear();
        }
        
        return [
            Date.NewYear(calendarYear(JANUARY)),
            Date.nthDayOfMonth(3,MONDAY, JANUARY, calendarYear(JANUARY), "Martin Luther King's Birthday"),
            Date.nthDayOfMonth(3,MONDAY, FEBRUARY, calendarYear(FEBRUARY), "President's Day"),
            Date.lastDayOfMonth(MONDAY, MAY, calendarYear(MAY), "Memorial Day"),        
            Date.findSetHoliday(JULY,4,calendarYear(JULY), "Independence Day"),
            Date.nthDayOfMonth(1,MONDAY,SEPTEMBER, calendarYear(SEPTEMBER), "Labor Day"),
            Date.nthDayOfMonth(2,MONDAY,OCTOBER, calendarYear(OCTOBER), "Columbus Day"),
            Date.findSetHoliday(NOVEMBER,11, calendarYear(NOVEMBER), "Veteran's Day"),
            Date.nthDayOfMonth(4,THURSDAY,NOVEMBER, calendarYear(NOVEMBER), "Thanksgiving Day"),
            Date.findSetHoliday(DECEMBER,25, calendarYear(DECEMBER), "Christmas Day")
        ];
    }

    Date.getDaysOffset = function(start, end)
    {
        return Math.round( (end - start) / DAY );
    }

    Date.prototype.addDaysOffset = function(days)
    {        
        var newDate = new Date(this);
        newDate.nextDate(365);
        return newDate;
    }
    
    Date.prototype.getMonthStr = function()
    {        
        return MONTHS[this.getMonth()];
    }

    Date.prototype.toISODateStr = function()
    {
        return this.toISOString().split('T')[0];        
    }

    Date.prototype.toISODate = function()
    {
        return this.toISOString().split('T')[0].replace(/-/g,'');        
    }

    Date.fromISODate = function(str)
    {
        var newDate = null;
        var not_a_number = str == null || str == "" || ( /^\d+$/.test(str) === false );
        if (not_a_number) return null;        
        try
        {
            if (str.length != 8) return null;

            var year = str.substr(0,4);
            newDate = new Date(year,JANUARY,1);
            if (str.length > 4)
            {
                var month = parseInt(str.substr(4,2))-1;
                newDate.setMonth(month);
            }            
            if (str.length == 8)
            {
                var date = str.substr(6,2);
                newDate.setDate(date);
            }                 
        }
        catch (exception)
        {
            console.log(exception); 
            console.log(newDate);           
        }                
        return newDate;
    }

    Date.prototype.getCalendarStr = function()
    {
        if (this.holidayName == null) this.holidayName = "";
        var calendarStr = this.getWeekDay() + " " + this.getMonthStr() + " " + this.getDate() + ", " + this.getFullYear();
        return calendarStr;
    }

    const DEFAULTSTART = Date.NewYear();
    const DEFAULTEND = Date.NewYear().addDaysOffset(365);
    console.log("consts:", DEFAULTSTART, DEFAULTEND);

    class Calendar
    {
        myStartDate = null;
        myEndDate = null;
        myDivId = "calendar";
    
        constructor(divId = "calendar", startDate = DEFAULTSTART, endDate = DEFAULTEND)
        {
            this.myStartDate = new Date(startDate);
            this.myEndDate = new Date(endDate);
            this.myDivId = divId;
            this.draw();
            console.log(JSON.stringify(this));           
        }

        insertDay(someDate)
        {            
            var day = document.createElement("div");
            day.id = someDate.toISODate();
            day.innerText = someDate.getCalendarStr();        
            day.classList.add("date");  
            
            var isSunday = someDate.getDay() === 0;
            var isSaturday = someDate.getDay() === 6;
            var isWeekend = isSaturday || isSunday;

            if (!someDate.isBackdate)
            {                
                if (isWeekend) day.classList.add("weekend");
                if (isSunday) day.classList.add("sunday");
                if (isSaturday) day.classList.add("saturday");  
            }
            else
            {
                day.classList.add("backdate");
            } 
            
            var calendar = document.getElementById(this.myDivId);
            if (isSunday) {
                var bump = document.createElement("div");
                bump.classList.add("week");
                if (calendar != null) calendar.appendChild(bump);
            }
            if (calendar != null) calendar.appendChild(day);
        }    

        draw()
        {
            var offsetDays = this.myStartDate.getDay();
            for (var offset = offsetDays; offset > 0; offset--) 
            {
                var date = new Date(this.myStartDate);
                this.insertDay(date.backDate(offset));
            }

            var days = Date.getDaysOffset(this.myStartDate, this.myEndDate);
            var date = new Date(this.myStartDate);
            for (var count = 0; count <= days; count++) 
            {
                this.insertDay(date);
                date.nextDate();
            }
            console.log("last date:", date);

            Date.getFederalHolidays(this.myStartDate).forEach(function(date)
            {                            
                var calendarDate = document.getElementById(date.toISODate())
                if (calendarDate != null)
                {
                    calendarDate.classList.add("holiday");
                    calendarDate.innerText = calendarDate.innerText + " " + date.holidayName                    
                }            
            });

            var weeks = document.getElementsByClassName("week");
            var counter = 1;             
            for (var week of weeks) 
            { 
                var name = "week" + counter.toDigits(2);
                week.classList.add(name);
                week.innerText = name;
                counter++; 
            }
        }        
    }

    function doRedirect(params)
    {
        var url = window.location.href.split('?')[0] + "?" + params;
        window.location.href = url;
    }

    function getUrlParameters()
    {
        var urlStr = window.location.search.substring(1) || null;
        if (urlStr == null) return {};
        var params = {};
        urlStr.split('&').forEach(function(param)
        {
            try
            {
                var key = param.split('=')[0];
                var value = param.split('=')[1];
                params[key] = value;
            } catch(e)
            {
                console.log(e);
            }
        });
        console.log("getUrlParameters:", params);
        return params;
    }
       
    function main() 
    {
        var args = getUrlParameters();         
        var start = Date.fromISODate(args.start) || DEFAULTSTART;
        var dateSpan = 365;
        var end = start.addDaysOffset(365);
        if (args.hasOwnProperty('end')) {
            end = Date.fromISODate(args.end);
            dateSpan = Date.getDaysOffset(start, end);
        }        
        console.log("main:", args, start, end, dateSpan);

        var calendar = new Calendar(divId = "calendar", startDate = start, endDate = end);
        
        document.getElementById("currentYear").innerText = start.toISODateStr();

        var lastYearButton = document.getElementById("btnLastYear");
        var lastyear = new Date(start);
        lastyear.setFullYear(start.getFullYear() - 1);
        var lastyearEnd = new Date(lastyear);
        lastyearEnd.nextDate(dateSpan);
        console.log("lastyear:", lastyear, dateSpan, lastyearEnd);
        lastYearButton.innerText = lastyear.toISODateStr();
        lastYearButton.onclick = function(event)
        {
            doRedirect("start=" + lastyear.toISODate() + "&end=" + lastyearEnd.toISODate());
        }

        var nextYearButton = document.getElementById("btnNextYear");
        var nextyear = new Date(start);
        nextyear.setFullYear(start.getFullYear() + 1);
        var nextyearEnd = new Date(nextyear);
        nextyearEnd.nextDate(dateSpan);
        console.log("nextyear:", nextyear, dateSpan, nextyearEnd);
        nextYearButton.innerText = nextyear.toISODateStr();
        nextYearButton.onclick = function(event)
        {
            doRedirect("start=" + nextyear.toISODate() + "&end=" + nextyearEnd.toISODate());
        };

        var selectMonth = document.getElementById("selectMonth");

        MONTHS.forEach(function(month, index){            
            var newMonth = document.createElement("option");
            newMonth.value = index;
            newMonth.text = month;
            newMonth.classList.add("month_choice");
            selectMonth.appendChild(newMonth);
        });
   
        selectMonth.selectedIndex = start.getMonth();
        selectMonth.onchange = function(event)
        {
            var month = event.target.selectedIndex;
            var newDate = new Date(start.getFullYear(),month,1);
            doRedirect("start=" + newDate.toISODate());
        };
        
    }

    document.addEventListener("DOMContentLoaded", function(event) { 
        main();
    });


</script>

<style>
    #calendar {
        display: table;
    }

    #currentYear {
        font-weight: bolder;
    }

    div.date {
        float: left;
        border : 1px solid black;
        height: 24vh;
        width: 12vw;
        padding : 1px;
        display: inline;
    }

    div.week {
        float: left;
        border : 1px solid black;
        height: 24vh;
        width: 8vw;
        padding : 1px;
        /* display: inline; */
        display: block;
        clear: both;
    }

    hr {
        display: block;
        clear: both;
    }

    div.weekend {
        background-color: #efefef;
    }

    div.backdate {
        border : 1px solid gray;
        color: gray;
        background: #bbb;
    }

    div.holiday {
        background-color: #ddf;
    }

    div.controls {
        float: left;
        margin: 5px;
    }

</style>
</html>